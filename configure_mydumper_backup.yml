---
- name: configure the mysql mydumper backup script with API
  hosts: "{{ HOSTS }}"
  remote_user: root

  tasks:
  - name: check mysqld is installed
    shell: command -v mysqld >/dev/null 2>&1
    register: is_mysqld_exist
    ignore_errors: yes

  - debug: msg="{{ is_mysqld_exist.rc }}"

  - name: create scripts dir if not available
    file:
      path: /root/scripts
      state: directory
      mode: '0755'
    
  - name: download the mysql backup script from DO spaces
    get_url:
      url: https://mkcl.sgp1.digitaloceanspaces.com/scripts/mysql-mydumper-backup.sh
      dest: /root/scripts/mysql-mydumper-backup.sh
      mode: '0644'
  
  - name: remove old backup script
    file:
      path: /root/scripts/mysql_mydumper_backup.sh
      state: absent

  - name: remove existing cron entry for gdrive upload
    shell: crontab -u root -l | grep -v '/root/scripts/gdrive_upload_sync'  | crontab -u root -

  - name: remove existing cron entry for mysql backup
    shell: crontab -u root -l | grep -v '/root/scripts/mysql_mydumper_backup.sh'  | crontab -u root -

  - name: removing old Ansible added cron with same name below
    cron:
      name: "### MySQL mydumper Backup and Uploading"
      state: absent  

  - name : adding a crontab for backup script to execute at specific hour and random minute in night
    cron: 
      name: "### MySQL mydumper Backup and Uploading"
      minute: "{{ 60 | random(step=5) }}"
      hour: "2"
      job: "/bin/bash /root/scripts/mysql-mydumper-backup.sh"
      
            